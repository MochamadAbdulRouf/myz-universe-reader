# PROJECT VERSI KEAMANAN APLIKASI
Seharusnya file .env dan node_modules tidak perlu dimasukan ke image docker jika ingin di deploy ke production, Saya akan menambahkannya ke kubernetes Secret untuk implementasi keamanan aplikasi yang baik.

## TOPOLOGI PROJECT 
![topologi-project-secure](./image/topologi-production-secure.jpeg)

## TAHAP BUILD YANG SAYA LAKUKAN
1. Membuat file "entrypoint.sh" untuk menyuntikan nilai environment variable (SUPABASE_URL dan SUPABASE_PUBLISHABLE_KEY) ke dalam file Java Script.Lalu file java script mana yang dimaksud? file javascript tersebut biasanya akan muncul setelah menjalankan command "npm run build" pada proyek React, TypeScript, dan Vite. Proses build akan mengkompilasi semua kode sumber seperti (file .ts, .tsx, dll) menjadi beberapa file statis yang di optimalkan. File java script utamanya akan diberi nama dengan pola "index-[hash(acak)].js".

2. Ubah isi file di path "/src/integrations/client.ts" menjadi seperti berikut 
```bash
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

// Ganti 'import.meta.env' dengan string placeholder yang unik.
// Tanda '__' di awal dan akhir membantu memastikan string ini tidak akan
// muncul secara tidak sengaja di tempat lain dalam kode.
const SUPABASE_URL = "__VITE_SUPABASE_URL__";
const SUPABASE_PUBLISHABLE_KEY = "__VITE_SUPABASE_PUBLISHABLE_KEY__";

// Bagian ini tidak perlu diubah. Ia akan menggunakan variabel placeholder di atas.
export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    storage: localStorage,
    persistSession: true,
    autoRefreshToken: true,
  }
});
```
note: saya menggantinya didalam vm jadi tidak saya ganti didalam repo ini takutnya terjadi error dengan versi Ai.

3. Berikan izin eksekusi untuk file skripnya
```bash
rouf@docker-client:~/myz-universe-reader$ chmod +x entrypoint.sh
```

4. Perbarui isi Dockerfile
saya membuat versi nama Dockerfile berbeda dengan nama Dockerfile.secure
```bash
# --- Tahap Build ---
FROM node:18-alpine as builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# --- Tahap Produksi ---
FROM nginx:stable-alpine

# Salin file statis dari tahap build
COPY --from=builder /app/dist /usr/share/nginx/html

# ----------------- PERUBAHAN DI SINI -----------------

# Salin skrip entrypoint ke dalam image
COPY entrypoint.sh /entrypoint.sh

# Beri izin eksekusi lagi di dalam image (sebagai jaminan)
RUN chmod +x /entrypoint.sh

# Jalankan skrip entrypoint sebagai perintah utama container
CMD ["/entrypoint.sh"]
```

Implementasi :
```bash
rouf@docker-client:~/myz-universe-reader$ vi Dockerfile.secure
rouf@docker-client:~/myz-universe-reader$ cat Dockerfile.secure 
# ---------- BUILD STAGE ----------
FROM node:18-alpine as builder
WORKDIR /app
COPY package*.json .
RUN npm install
COPY . .
RUN npm run build

# ----------- BUILD IMAGE SERVER ----------
FROM nginx:stable-alpine

COPY --from=builder /app/dist /usr/share/nginx/html

COPY entrypoint.sh /entrypoint.sh

RUN chmod +x /entrypoint.sh

CMD ["/entrypoint.sh"]
```


5. Saya melakukan Build image baru dengan tag berbeda
```bash
rouf@docker-client:~/myz-universe-reader$ docker build -f Dockerfile.secure -t mochabdulrouf/react-comic-app:3.1-production-secure .
[+] Building 54.7s (18/18) FINISHED                                                                                  docker:default
 => [internal] load build definition from Dockerfile.secure                                                                    0.1s
 => => transferring dockerfile: 401B                                                                                           0.0s 
 => WARN: FromAsCasing: 'as' and 'FROM' keywords' casing do not match (line 2)                                                 0.1s 
 => [internal] load metadata for docker.io/library/nginx:stable-alpine                                                         2.6s 
 => [internal] load metadata for docker.io/library/node:18-alpine                                                              2.6s
 => [auth] library/nginx:pull token for registry-1.docker.io                                                                   0.0s 
 => [auth] library/node:pull token for registry-1.docker.io                                                                    0.0s 
 => [internal] load .dockerignore                                                                                              0.1s
 => => transferring context: 65B                                                                                               0.0s 
 => [builder 1/6] FROM docker.io/library/node:18-alpine@sha256:8d6421d663b4c28fd3ebc498332f249011d118945588d0a35cb9bc4b8ca09d  0.0s
 => [internal] load build context                                                                                              0.4s 
 => => transferring context: 16.75kB                                                                                           0.3s 
 => CACHED [stage-1 1/4] FROM docker.io/library/nginx:stable-alpine@sha256:30f1c0d78e0ad60901648be663a710bdadf19e4c10ac6782c2  0.0s 
 => CACHED [builder 2/6] WORKDIR /app                                                                                          0.0s
 => CACHED [builder 3/6] COPY package*.json .                                                                                  0.0s 
 => CACHED [builder 4/6] RUN npm install                                                                                       0.0s 
 => [builder 5/6] COPY . .                                                                                                     1.8s 
 => [builder 6/6] RUN npm run build                                                                                           41.9s
 => [stage-1 2/4] COPY --from=builder /app/dist /usr/share/nginx/html                                                          0.2s
 => [stage-1 3/4] COPY entrypoint.sh /entrypoint.sh                                                                            0.2s
 => [stage-1 4/4] RUN chmod +x /entrypoint.sh                                                                                  1.0s
 => exporting to image                                                                                                         0.5s
 => => exporting layers                                                                                                        0.4s
 => => writing image sha256:8cfdcce4b8e40b32bddc4b6d8917d80d1ec7012842b70edffaf848ecaa79686b                                   0.0s
 => => naming to docker.io/mochabdulrouf/react-comic-app:3.1-production-secure                                                 0.0s
```



6. Saya melakukan testing pada image yang saya build untuk melihat apakah image bisa berjalan di container, Sebelum saya push ke Docker Hub
```bash
rouf@docker-client:~/myz-universe-reader$ docker run -d -p 80:80 mochabdulrouf/react-comic-app:3.1-production-secure 
78ad9de5cf045571fa0151ebe925fde5fdb13bc4aa734d0163b9cbf879aec144
rouf@docker-client:~/myz-universe-reader$ docker logs 78
File JavaScript ditemukan: /usr/share/nginx/html/assets/index-B3_MIc5C.js
Mengganti environment variables...
Penggantian selesai.
Memulai Nginx...
2025/10/16 04:06:40 [notice] 1#1: using the "epoll" event method
2025/10/16 04:06:40 [notice] 1#1: nginx/1.28.0
2025/10/16 04:06:40 [notice] 1#1: built by gcc 14.2.0 (Alpine 14.2.0)
2025/10/16 04:06:40 [notice] 1#1: OS: Linux 5.15.0-141-generic
2025/10/16 04:06:40 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576
2025/10/16 04:06:40 [notice] 1#1: start worker processes
2025/10/16 04:06:40 [notice] 1#1: start worker process 9
rouf@docker-client:~/myz-universe-reader$ docker ps
CONTAINER ID   IMAGE                                                 COMMAND                  CREATED         STATUS         PORTS                                 NAMES
78ad9de5cf04   mochabdulrouf/react-comic-app:3.1-production-secure   "/docker-entrypoint.…"   9 seconds ago   Up 8 seconds   0.0.0.0:80->80/tcp, [::]:80->80/tcp   pedantic_herschel
```

7. Saya melakukan push ke Docker Hub
```bash
rouf@docker-client:~/myz-universe-reader$ docker push mochabdulrouf/react-comic-app:3.1-production-secure 
The push refers to repository [docker.io/mochabdulrouf/react-comic-app]
aa67cd9f888a: Pushed
d00b17860c0b: Pushed
208c5d3ed0eb: Pushed
90ec27130398: Layer already exists
a231a657395e: Layer already exists
5f23a9cf34f1: Layer already exists
7d9abb9ab3b7: Layer already exists
34034c523565: Layer already exists
570a1c87f279: Layer already exists
412e147b334c: Layer already exists
922ec217407c: Layer already exists
3.1-production-secure: digest: sha256:80e2b6c89a2c38e8732f46d93bc4cd73d5ead6f1b273b5d2a2b7d6b70a8504e3 size: 2613
```


8. Buat file konfigurasi untuk Deployment baru dengan tambahan objek Secret
9. Lalu saya melakukan eksekusi pada file konfigurasi
```bash
controlplane ~/deployment ➜  kubectl apply -f comic-deployment-secure.yaml 
secret/comic-secret created
deployment.apps/comic-deployment created
service/comic-service created
```

10. Melihat semua objek apakah berjalan
```bash
controlplane ~/deployment ➜  kubectl get all
NAME                                   READY   STATUS    RESTARTS   AGE
pod/comic-deployment-7b4799d55-gblpr   1/1     Running   0          37s
pod/comic-deployment-7b4799d55-gzggj   1/1     Running   0          37s
pod/comic-deployment-7b4799d55-spt48   1/1     Running   0          37s

NAME                    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
service/comic-service   NodePort    172.20.47.93   <none>        80:30002/TCP   38s
service/kubernetes      ClusterIP   172.20.0.1     <none>        443/TCP        112m

NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/comic-deployment   3/3     3            3           38s

NAME                                         DESIRED   CURRENT   READY   AGE
replicaset.apps/comic-deployment-7b4799d55   3         3         3       38s
```

11. Memverifikasi apakah secret berhasil di terapkan
```bash
controlplane ~/deployment ➜  kubectl get secrets 
NAME           TYPE     DATA   AGE
comic-secret   Opaque   3      76s

controlplane ~/deployment ➜  kubectl describe secrets comic-secret 
Name:         comic-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
VITE_SUPABASE_PROJECT_ID:       20 bytes
VITE_SUPABASE_PUBLISHABLE_KEY:  208 bytes
VITE_SUPABASE_URL:              40 bytes
```

12. Memverifikasi didalam Container apakah environment variable secret di file konfigurasi sudah masuk kedalam lingkungan container
```bash
controlplane ~/deployment ➜  kubectl exec comic-deployment-7b4799d55-gzggj -it -- /bin/sh
/ # env
COMIC_SERVICE_PORT_80_TCP=tcp://172.20.47.93:80
KUBERNETES_SERVICE_PORT=443
KUBERNETES_PORT=tcp://172.20.0.1:443
HOSTNAME=comic-deployment-7b4799d55-gzggj
SHLVL=1
HOME=/root
PKG_RELEASE=1
VITE_SUPABASE_PROJECT_ID=nurpudorwottgiffizac
DYNPKG_RELEASE=1
COMIC_SERVICE_SERVICE_HOST=172.20.47.93
TERM=xterm
NGINX_VERSION=1.28.0
KUBERNETES_PORT_443_TCP_ADDR=172.20.0.1
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
NJS_VERSION=0.8.10
COMIC_SERVICE_PORT=tcp://172.20.47.93:80
KUBERNETES_PORT_443_TCP_PORT=443
COMIC_SERVICE_SERVICE_PORT=80
KUBERNETES_PORT_443_TCP_PROTO=tcp
NJS_RELEASE=1
VITE_SUPABASE_PUBLISHABLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51cnB1ZG9yd290dGdpZmZpemFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MTA4MDIsImV4cCI6MjA3NTQ4NjgwMn0.3N9GgigDy9QToWBfN_C-K1zNFCHJkZPajNR0tXDGtmA
VITE_SUPABASE_URL=https://nurpudorwottgiffizac.supabase.co
COMIC_SERVICE_PORT_80_TCP_ADDR=172.20.47.93
COMIC_SERVICE_PORT_80_TCP_PORT=80
KUBERNETES_PORT_443_TCP=tcp://172.20.0.1:443
KUBERNETES_SERVICE_PORT_HTTPS=443
COMIC_SERVICE_PORT_80_TCP_PROTO=tcp
KUBERNETES_SERVICE_HOST=172.20.0.1
PWD=/
/ #
```

13. Melakukan test pengujian di browser lewat Node Port
![test-pengujian-1](./image/image-secure.png)

14. Test Pengujian login ke database external
![test-pengujian-2](./image/image-secure-1.png)
